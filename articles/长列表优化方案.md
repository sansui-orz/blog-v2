# é•¿åˆ—è¡¨ä¼˜åŒ–æ–¹æ¡ˆè§£æ

[tag]:react|list|component
[create]:2020-07-29

ğŸ‘‰ [react-infinite-auto-scroller](https://github.com/sansui-orz/react-infinite-auto-scroller)

æ—¥å¸¸å·¥ä½œä¸­ï¼Œç»å¸¸é‡åˆ°é•¿åˆ—è¡¨ï¼ˆå•†å“åˆ—è¡¨ï¼Œç¤¾åŒºå¸–å­åˆ—è¡¨ï¼ŒåŠ¨æ€åˆ—è¡¨ï¼Œè§†é¢‘æµâ€¦â€¦ï¼‰ã€‚æ‰€ä»¥ä¹Ÿäº†è§£å½“ç”¨æˆ·åˆ·åˆ°äº†å¤§é‡å†…å®¹æ—¶ï¼Œç”±äºDOMæ•°é‡æ¿€å¢ï¼Œé¡µé¢çš„æ€§èƒ½é¢ä¸´çš„æŒ‘æˆ˜ã€‚

è€Œå¯¹é•¿åˆ—è¡¨çš„ä¼˜åŒ–åº“ä¹Ÿæœ‰å¾ˆå¤šï¼Œä½†æ˜¯å®é™…åº”ç”¨åˆ°é¡¹ç›®ä¸­å¤§å¤šåˆä¸åŒ¹é…ï¼Œè¦ä¹ˆå›ºå®šé«˜åº¦ï¼Œè¦ä¹ˆéœ€è¦å®šåˆ¶é€»è¾‘ã€‚æ‰€ä»¥å°±è‡ªå·±æ‰‹åŠ¨å†™ä¸€éé•¿åˆ—è¡¨çš„ä¼˜åŒ–ï¼Œäº†è§£ä¼˜åŒ–æ¦‚å¿µä»¥åŠå…¶ä¸­çš„é—®é¢˜ã€‚

## æ„å»ºç®€æ˜“çš„åˆ—è¡¨

é¦–å…ˆæ­å»ºä¸€ä¸ªç®€æ˜“çš„åˆ—è¡¨ç»„ä»¶

æ–°å»ºlist.tsx

```tsx
import React, { Component } from 'react';
import Item from '../item';

export default class List extends Component<{}, {
  list: Array<{ text: string; img?: string; }>
}> {
  private refList = React.createRef<HTMLDivElement>();

  private lock = false;

  state = {
    list: [],
  };

  componentDidMount() {
    this.setState({
      list: this.getList(50),
    });
    window.addEventListener('scroll', this.listenScroll, false); // ç›‘å¬æ˜¯å¦æ»šåŠ¨åˆ°åº•éƒ¨ï¼Œè¿›è¡Œè§¦åº•åŠ è½½
  }

  componentWillUnmount() {
    window.removeEventListener('scroll', this.listenScroll, false); // å¸è½½æ—¶ç§»é™¤äº‹ä»¶ç›‘å¬
  }

  render() {
    return (
      <div className="list" ref={this.refList}>
        <div className="count">{this.state.list.length}</div>
        {this.state.list.map((item: { text: string; img?: string; }, index) => {
          return (
            <Item key={index} text={item.text} img={item.img} /> // åˆ—è¡¨é¡¹ï¼Œè¿™é‡Œåé¢éœ€è¦æ›´æ¢ç§°æ— é™æ»šåŠ¨ç»„ä»¶
          );
        })}
      </div>
    );
  }

  // ç®€å•å®ç°è§¦åº•åŠ è½½
  private listenScroll = () => { // ç›‘å¬æ˜¯å¦åˆ°åº•éƒ¨
    if (this.lock) return;
    // é˜²æŠ–
    this.lock = true;
    setTimeout(() => {
      this.lock = false;
    }, 100);
    const targetEle = this.refList?.current;
    if (targetEle) {
      const { bottom } = targetEle.getBoundingClientRect();
      // å¦‚æœè·ç¦»åº•éƒ¨è¿˜æœ‰åŠå±
      if (bottom < window.innerHeight * 1.5) {
        const list: Array<{ text: string; img?: string; }> = this.state.list;
        this.setState({
          list: list.concat(this.getList(50)),
        });
      }
    }
  };

  private getList(len: number) { // mockæ•°æ®æ¥å£è¯·æ±‚
    const list: Array<{ text: string; img?: string; }> = [];
    for (var i = 0; i < len; i++) {
      list.push(this.getItem());
    }
    return list;
  }

  private getItem(): { text: string, img?: string } {
    const t = 'é«˜é˜¶ç»„ä»¶ï¼ˆHOCï¼‰æ˜¯ React ä¸­ç”¨äºå¤ç”¨ç»„ä»¶é€»è¾‘çš„ä¸€ç§é«˜çº§æŠ€å·§ã€‚HOC è‡ªèº«ä¸æ˜¯ React API çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒæ˜¯ä¸€ç§åŸºäº React çš„ç»„åˆç‰¹æ€§è€Œå½¢æˆçš„è®¾è®¡æ¨¡å¼ã€‚';
    return {
      text: t.substr(Math.floor(Math.random() * t.length / 2), t.length / 2 + Math.floor(Math.random() * t.length / 2)), // éšæœºæˆªå–ä¸€æ®µæ–‡æœ¬
      img: Math.random() > 0.6 ? `http://iph.href.lu/200x${Math.floor(100 + Math.random() * 300)}` : '', // éšæœºæ·»åŠ ä¸€å¼ å›¾ç‰‡
    };
  }
}
```

æ–°å»ºitem.tsxï¼Œä¸ºäº†å°½é‡è¿˜åŸå®é™…åº”ç”¨åœºæ™¯ï¼Œæˆ‘ä»¬å¯ä»¥å°½é‡å¢åŠ ä¸€äº›å…ƒç´ ã€‚

```tsx
import React, { Component } from 'react';

import './index.css';

interface IProps {
  text: string;
  img?: string;
}

class Item extends Component<IProps> {
  render() {
    const { text, img } = this.props;
    return (
      <div className="item">
        <div className="user">
          <img className="avatar" src={require('../../images/3.png').default} />
          <div className="username">123</div>
        </div>
        <p className="text">{text}</p>
        {img ? <img className="img" src={img} alt=""/> : null}
        <div className="controls">
          <div className="action1">
            <img src={require('../../images/1.png').default} />
            0
          </div>
          <div className="action2">
            <img src={require('../../images/2.png').default} />
            0
          </div>
          <div className="action3">
            <img src={require('../../images/4.png').default} />
            0
          </div>
        </div>
      </div>
    );
  }
}


export default Item;
```

æ­¤æ—¶çš„åˆ—è¡¨çœ‹ä¸Šå»é•¿è¿™æ ·â¬‡ï¸

![åˆ—è¡¨](https://lms-flies.oss-cn-guangzhou.aliyuncs.com/blog/imgs/20200729154731.jpg!trans_webp)

æ­¤æ—¶ï¼Œæˆ‘ä»¬åˆ—è¡¨æœ‰å¤šå°‘é¡¹ï¼Œå°±ä¼šæœ‰å¤šå°‘ä¸ªItemç»„ä»¶ã€‚

## ä¸ºä»€ä¹ˆä¼šå¡

æ¥ç€æˆ‘ä»¬æ¥è®¾è®¡é•¿åˆ—è¡¨ä¼˜åŒ–çš„é€»è¾‘ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦ææ¸…æ¥šä¸ºä»€ä¹ˆåˆ—è¡¨é•¿äº†ä¼šå¡é¡¿ï¼Œæˆ‘æ€»ç»“äº†ä¸€ä¸‹æœ‰ä»¥ä¸‹ä¸¤ä¸ªåŸå› ï¼š

1. Reactæ¸²æŸ“åƒåŠ›ï¼Œå½“reactçš„è™šæ‹ŸDOMç»“æ„å¤æ‚æ—¶ï¼ŒDOMæ›´æ–°å°±ä¼šæ˜æ˜¾è€—æ—¶ï¼ˆå› ä¸ºDIFFç®—æ³•éœ€è¦éå†æ–°æ—§DOMç»“æ„ï¼‰

2. å¤§é‡DOMæ“ä½œï¼Œå³ä½¿æ˜¯React DiffèŠ‚ç‚¹é€Ÿåº¦å¤Ÿå¿«ï¼Œä½†æ˜¯æ¶‰åŠåˆ°å¤§é‡domèŠ‚ç‚¹å˜æ›´éœ€è¦ä¸domè¿›è¡Œäº¤äº’ï¼Œè¦çŸ¥é“domæ“ä½œéƒ½æ˜¯åŒæ­¥çš„ï¼Œä¸”domæ“ä½œè€—æ—¶å¹¶ä¼šé˜»å¡jså¾€ä¸‹æ‰§è¡Œï¼Œæ‰€ä»¥å½“å¤§é‡domäº¤äº’æ—¶ï¼Œé¡µé¢ä¼šå˜å¾—æ˜æ˜¾å¡é¡¿ã€‚

## è§£å†³æ–¹æ¡ˆ

é’ˆå¯¹é•¿åˆ—è¡¨å¡é¡¿æˆ‘ä»¬çŸ¥é“äº†åŸå› ï¼Œå°±å¯ä»¥é’ˆå¯¹æ€§çš„å¯¹å…¶è¿›è¡Œä¼˜åŒ–äº†ã€‚

ä»åŸå› æ¥çœ‹ï¼Œä¸»è¦é—®é¢˜åœ¨äºåˆ—è¡¨é•¿äº†ä¹‹åï¼ŒDOMç»“æ„çš„å¤æ‚åº¦å¢åŠ ï¼Œå¯¼è‡´jsè°ƒç”¨æ—¶é—´é•¿ï¼Œdomæ¸²æŸ“é¢‘ç¹ã€‚

## å…·ä½“å®ç°

### ç¬¬ä¸€ä¸ªæƒ³æ³•

æ—¢ç„¶æ˜¯å› ä¸ºdomç»“æ„å¤æ‚ï¼Œé‚£æˆ‘ä»¬å‡å°‘domæ•°é‡ä¸ç»“æ„ä¸å°±å¥½å’¯ã€‚æˆ‘è„‘ä¸­æµ®ç°äº†ç¬¬ä¸€ä¸ªæƒ³æ³•ï¼Œå¹¶ä¸”ç«‹å³å†™å‡ºäº†å¤§æ¦‚çš„è§£å†³æ–¹æ³•ã€‚

```tsx
// å£°æ˜Mapå­˜å‚¨DOMèŠ‚ç‚¹ä¸REACTç»„ä»¶æ˜ å°„
const map = new Map();

// ä½¿ç”¨IntersectionObserveråšèŠ‚ç‚¹æ›å…‰ç›‘å¬
const intersectionObserver = new IntersectionObserver((entrys) => {
    entrys.forEach((entry) => {
        const target = entry.target;
        const handle = map.get(target);
        handle && handle(entry.intersectionRadio > 0);
    });
}, { rootMargin: '50% 50% 50% 50%' });

export default function createInfiniteScrollItem(Component) {
  return class InfiniteScrollItem extends React.Component {
    state = {
      show: true,
      height: 0,
      ready: false,
    };

    private ref = React.createRef<HTMLDivElement>();

    componentDidMount() {
      const current = this.ref.current;
      // å°†èŠ‚ç‚¹ä¸REACTæ˜ å°„å­˜å…¥mapä¸­
      map.set(current, (show: boolean) => {
        if (this.state.ready && show !== this.state.show) {
          this.setState({ show });
        }
      });
      // ç›‘å¬è¯¥DOMèŠ‚ç‚¹æ›å…‰
      intersectionObserver.observe(current);
    }

    componentWillUnmount() {
      // å¸è½½æ—¶æ¸…é™¤å¼•ç”¨
      const current = this.ref.current;
      intersectionObserver.unobserve(current);
      map.delete(current);
    }

    render() {
      return (
        <div ref={this.ref} style={{ height: this.state.height || 'auto' }} >
          {(this.state.show && this.state.ready) ? <Component {...this.props} infiniteReady={this.readyHandle} infiniteReportHeight={this.reportHeight}> : null}
        </div>
      );
    }

    private reportHeight = (height: number) => {
      // é«˜åº¦ç”±å…·ä½“çš„ä¸šåŠ¡ITEMèŠ‚ç‚¹ä¸ŠæŠ¥
      this.setState({ height });
    };

    private readyHandle = () => {
      // ITEMèŠ‚ç‚¹æ˜¯å¦å‡†å¤‡å®Œæ¯•ï¼Œåªæœ‰å‡†å¤‡å®Œæ¯•çš„éšè—èŠ‚ç‚¹æ‰ä¼šè¢«ç§»é™¤
      this.setState({ ready: true, show: this.getVisibility() });
    }

    private getVisibility = () => {
      // æ‰‹åŠ¨è®¡ç®—è¯¥èŠ‚ç‚¹æ˜¯å¦æ›å…‰
      const rect = this.ref.current.getBoundingClientRect();
      const wh = window.innerHeight;
      const ww = window.innerWidth;
      return rect.top > -0.5 * wh && rect.bottom < 1.5 * wh && rect.left  < 1.5 * ww && rect.right > -0.5 * ww;
    }
  }
}
```

è§£é‡Šä¸€ä¸‹ä¸Šé¢çš„ä»£ç 

1. é¦–å…ˆï¼Œå£°æ˜ä¸€ä¸ª`IntersectionObserver`å®ä¾‹æ¥ç›‘å¬èŠ‚ç‚¹çš„éšè—ä¸æ˜¾ç¤º

2. å£°æ˜ä¸€ä¸ªmapå¯¹è±¡å°†domå…ƒç´ ä¸å›è°ƒè¿›è¡Œå…³è”

3. å£°æ˜ä¸€ä¸ªé«˜é˜¶å‡½æ•°`createInfiniteScrollItem`ï¼Œç”¨æ¥åŒ…è£¹åˆ—è¡¨é¡¹ç»„ä»¶ï¼ŒåŒæ—¶æä¾›æ›å…‰æ˜¾ç¤ºï¼Œéšè—åˆ é™¤çš„é€»è¾‘

ä¸»è¦çš„é€»è¾‘éƒ½åœ¨é«˜é˜¶ç»„ä»¶é‡Œé¢ï¼Œè¯¥ç»„ä»¶ä»…ä»…åªæ˜¯ç»™åˆ—è¡¨é¡¹ç»„ä»¶åŒ…è£¹äº†ä¸€å±‚divï¼Œå€Ÿç€è¿™ä¸ªdivèŠ‚ç‚¹ï¼Œç›‘å¬å…¶éšè—ä¸æ˜¾ç¤ºï¼ŒåŒæ—¶å½“Componentå‡†å¤‡å®Œæ¯•æ—¶å¯ä»¥ä¸ŠæŠ¥ready, æ­¤æ—¶ç›‘å¬åˆ°èŠ‚ç‚¹æ˜¾ç¤ºéšè—æ˜¯æ‰ä¼šæ”¹å˜showå±æ€§ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“`infiniteReady`è°ƒç”¨æ—¶ï¼Œè¯¥ç»„ä»¶å¯èƒ½å·²ç»å¤„äºéšè—çŠ¶æ€ï¼Œè€Œæ­¤æ—¶éœ€è¦ä¸»åŠ¨åˆ¤æ–­ä¸€ä¸‹å½“å‰å…ƒç´ çš„æ˜¾ç¤ºéšè—, å¦‚æœä¸è°ƒç”¨ï¼Œå°±åªèƒ½ç­‰åˆ°ä¸‹æ¬¡å…ƒç´ å¯è§æ€§å˜åŒ–æ—¶æ‰èƒ½èµ·æ•ˆï¼Œè¿™æ˜¯ä¸åˆç†çš„ã€‚

è€Œåˆ—è¡¨é¡¹ç»„ä»¶å†…ä¹Ÿéœ€è¦é€šè¿‡`infiniteReportHeight`æ–¹æ³•ä¸ŠæŠ¥é«˜åº¦ï¼Œåªæœ‰ä¸ŠæŠ¥é«˜åº¦çš„ç»„ä»¶æ‰èƒ½è¢«éšè—ï¼Œå› ä¸ºè¿™æ ·æ‰ä¸ä¼šå½±å“åˆ°é¡µé¢æ•´ä½“çš„å¸ƒå±€ã€‚

ç‰¹åˆ«éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“ç»„ä»¶è¢«å¸è½½æ—¶æ³¨æ„å°†intersectionObserverä¸mapæ•°æ®æ¸…é™¤ï¼Œå¦åˆ™ä¼šå†…å­˜æ³„æ¼ã€‚

è¿™æ ·æˆ‘ä»¬å°±ç®€å•çš„å®ç°äº†ç¬¬ä¸€ä¸ªæ— é™åŠ è½½çš„ç»„ä»¶ï¼Œå½“æˆ‘ä»¬è¿è¡Œèµ·æ¥çš„æ—¶å€™ä¼šå‘ç°ï¼Œå¦‚æœæ˜¯æ»‘çš„æ…¢çš„è¯ï¼Œä¼¼ä¹æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯å½“ä½ å¿«é€Ÿæ»‘åŠ¨æ—¶ï¼Œå°±ä¼šå‘ç°é¡µé¢å˜å¾—å¾ˆå¡ï¼Œæ¯”ä¼˜åŒ–å‰è¿˜è¦å¡ã€‚è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ

è¿™æ˜¯å› ä¸ºæˆ‘ä»¬é¢‘ç¹çš„è°ƒç”¨äº†setStateå»æ”¹å˜ç»„ä»¶çš„çŠ¶æ€ï¼Œå½“å¿«é€Ÿæ»‘åŠ¨æ—¶ï¼Œä¸€ä¸‹å˜åŒ–çš„ç»„ä»¶å¤ªå¤šï¼Œå°±äº§ç”Ÿäº†å¾ˆå¤šçš„setStateã€‚

è¦çŸ¥é“setStateçš„æ—¶å€™å¹¶ä¸å•å•åªæ˜¯è°ƒç”¨ä¸€ä¸ªå‡½æ•°é‚£ä¹ˆç®€å•ï¼Œç”¨â€œå†°å±±ä¸€è§’â€æ¥å½¢å®¹è¿™ä¸ªæ–¹æ³•å†é€‚åˆä¸è¿‡äº†ï¼Œå®ƒè®¾ç½®å®Œä¹‹åçš„REACTæ›´æ–°ï¼ŒDOMæ›´æ–°å¯¼è‡´é¡µé¢çš„å¡é¡¿ã€‚

å¤§é‡çš„setStateäº§ç”Ÿäº†å¤§é‡jsè°ƒç”¨å †ç§¯ï¼Œå¯¼è‡´é¡µé¢å¡é¡¿ï¼Œå¯¼è‡´IntersectionObserveræ— æ³•è¢«è°ƒç”¨ï¼ˆå› ä¸ºIntersectionObserveræ˜¯åœ¨æµè§ˆå™¨ç©ºé—²æ—¶æ‰ä¼šè¢«è°ƒç”¨çš„ï¼‰ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¼šé‚£ä¹ˆå¡çš„åŸå› äº†ã€‚

æ‰€ä»¥è¿™ä¸ªæ–¹æ³•è¡¨é¢ä¸Šçœ‹ä¼¼ä¹è¡Œå¾—é€šï¼Œä½†æ˜¯å…¶å®æ˜¯ä¸å¯¹çš„ï¼Œå°¤å…¶æ˜¯å¤§é‡çš„**setStateéƒ½æ˜¯å•ç‹¬çš„è°ƒç”¨**ï¼Œå¹¶ä¸ä¼šè¢«åˆå¹¶ï¼Œæ€§èƒ½çš„æŸè€—æ˜¯æå¤§çš„ï¼ˆReactå¹¶æ²¡æœ‰æä¾›ä¸»åŠ¨åˆå¹¶setStateçš„æ‰‹æ®µï¼Œæˆ–è€…ä½¿ç”¨redux, mobxè¿™ç±»çš„å…¨å±€çŠ¶æ€ç®¡ç†åº“æ‰èƒ½å®ç°å¤šæ¬¡è®¾ç½®ä¸€æ¬¡æ›´æ–°ï¼‰ã€‚

è€ƒè™‘åˆ°ä»…ä»…æ˜¯ä¸€ä¸ªé•¿åˆ—è¡¨çš„ç®€å•ç»„ä»¶å¹¶ä¸éœ€è¦ä½¿ç”¨redux, mobxæ­¤ç±»çš„åº“ï¼ˆå¦‚æœé¡¹ç›®ä¸­æœ¬æ¥å°±ç”¨åˆ°åˆå¦è¯´ï¼‰ã€‚

é‚£ä¹ˆæ¢ä¸€ä¸ªæ€è·¯ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠåˆ—è¡¨æ•°æ®æŠ½ç¦»åˆ°ä¸Šä¸€å±‚çš„ç»„ä»¶ä¸­ï¼Œç”¨ä¸€ä¸ªlistç»„ä»¶å°†itemséƒ½åŒ…è£¹èµ·æ¥ï¼Œè¿™æ ·å°±å¯ä»¥éšå¿ƒæ‰€æ¬²çš„æ›´æ”¹åˆ—è¡¨æ•°æ®è€Œä¸ä¼šæ²¡é¡¹æ›´æ–°éƒ½setStateäº†ã€‚

### ä¼˜åŒ–åæ–¹æ¡ˆ

æŠ½ç¦»å‡ºInfiniteScrollç»„ä»¶ã€‚

```tsx
export default class InfiniteScroll extends Component {
  render() {
    const list2 = this.sortList(this.state.list);
    return (
      <div className="infinite-scroll">
        {list2.map((item, index) => {
          const key = this.props.id ? item[this.props.id] : index;
          return (
            <InfiniteScrollItem
              key={key}
              index={item.is_index}
              is_height={item.is_height}
              reportHeight={reportHeight}
              renderItem={this.renderItem}
              item={item}
            />
          );
        })}
      </div>
    );
  }
}
```

ä»ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹åˆ°æœ‰ä¸ªsortListçš„æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•çš„ä½œç”¨æ˜¯ **â€œä½¿ç”¨jsåˆ¤æ–­å“ªäº›ç»„ä»¶æ˜¯æ˜¾ç¤ºçš„ï¼Œå“ªäº›ç»„ä»¶æ˜¯éšè—çš„â€**ã€‚

ä¸ºä»€ä¹ˆè¦ä½¿ç”¨jsåˆ¤æ–­å‘¢? å› ä¸ºjsè¿è¡Œé€Ÿåº¦å¿«, æ—¢ç„¶å·²ç»çŸ¥é“äº†æ¯ä¸ªå…ƒç´ çš„é«˜åº¦ï¼Œé‚£å°±æ²¡æœ‰å¿…è¦é€šè¿‡`IntersectionObserver`æˆ–è€…`getBoundingClientRect`å»åŠ¨æ€è·å–å…ƒç´ æ˜¯å¦æ˜¾ç¤ºäº†ã€‚

æˆ‘ä»¬åªéœ€è¦çŸ¥é“çˆ¶ç›’å­å½“å‰çš„topï¼Œå°±å¯ä»¥è‡ªå·±è®¡ç®—å‡ºæ¥åˆ—è¡¨å†…çš„å“ªäº›å…ƒç´ æ˜¯å¯è§çš„ã€‚å……åˆ†åˆ©ç”¨å¥½jsæ‰§è¡Œæ¯”domäº¤äº’å¿«çš„ä¼˜ç‚¹ã€‚

è€ŒsortListè¿™ä¸ªæ–¹æ³•å°±æ˜¯é€šè¿‡çˆ¶ç›’å­çš„topå€¼ï¼Œä¸æ¯ä¸ªåˆ—è¡¨é¡¹é«˜åº¦å»è®¡ç®—å“ªäº›å…ƒç´ æ˜¯å¯è§çš„ã€‚

```tsx
private sortList = (list) => {
    let top = this.state.boxTop; // ç›’å­æ»šåŠ¨é«˜åº¦ï¼Œåªéœ€è¦ç›‘å¬scrollå¹¶æ›´æ–°listç›’å­çš„topå€¼
    const minTop = -this.windowHeight; // è·ç¦»è§†å›¾é¡¶éƒ¨ä¸€å±å¹•
    const maxTop = this.windowHeight * 2; // è·ç¦»è§†å›¾åº•éƒ¨ä¸€å±å¹•
    const _list: any[] = [];
    list.forEach((item, index) => {
      if (item.is_height) { // ä¸ŠæŠ¥äº†heightä¹Ÿæ„å‘³ç€åŠ è½½å®Œæˆäº†
        top += item.is_height;
        if (!item.is_loaded || top > minTop && top < maxTop) { // å¦‚æœè¯¥åˆ—è¡¨é¡¹è¿˜æœªç¡®è®¤æœ€ç»ˆé«˜åº¦ï¼Œæˆ–è€…åœ¨åˆ¤æ–­èŒƒå›´å†…
          _list.push(item);
        } else { // å¦‚æœä¸åœ¨åˆ¤æ–­èŒƒå›´å†…
          const lastItem = _list[_list.length - 1];
          if (lastItem?.type === 'block') { // åˆ¤æ–­æ–°åˆ—è¡¨å¯¹åä¸€é¡¹æ˜¯ä¸æ˜¯ä¸€ä¸ªç©ºdiv
            lastItem.is_height += item.is_height; // æ›´æ–°è¿™ä¸ªç©ºdivçš„é«˜åº¦
            lastItem.maxIndex = index; // è®°å½•ä¸€ä¸‹éšè—çš„æœ€å¤§é¡¹çš„index
            lastItem.id = lastItem.minIndex + '/' + lastItem.maxIndex; // ä½¿ç”¨èŒƒå›´åškey
          } else { // å¦‚æœåˆ—è¡¨é¡¹æœ€åä¸€é¡¹ä¸æ˜¯ç©ºdivï¼Œåˆ™æ·»åŠ ä¸€ä¸ªç©ºdiv
            _list.push({
              type: 'block',
              is_height: item.is_height,
              maxIndex: index,
              minIndex: index,
              id: index + '/' + index,
            });
          }
        }
      } else {
        _list.push(item); // å› ä¸ºheightæœ‰å¯èƒ½æ˜¯å¼‚æ­¥çš„ï¼Œæ‰€ä»¥ä¸€å¼€å§‹çš„æ—¶å€™åˆ—è¡¨é¡¹æ˜¯æ²¡æœ‰heightå€¼çš„ï¼Œè¿™æ—¶å€™éœ€è¦å°†è¯¥é¡¹æ˜¾ç¤ºå‡ºæ¥ï¼Œåªæœ‰ç­‰åˆ°å®ƒåŠ è½½å®Œæ¯•äº†æ‰åŠ¨æ€è®¡ç®—æ˜¯å¦åŠ è½½å®Œæˆ
      }
    });
    return _list;
  }
```

sortListçš„å®ç°å°±æ˜¯éµå¾ªç€ **â€œæœªåŠ è½½å®Œæˆçš„ä¸åœ¨æ˜¾ç¤ºèŒƒå›´å†…çš„å…ƒç´ å¯ä»¥æ˜¾ç¤ºï¼Œå…¶ä»–éšè—åˆ—è¡¨é¡¹å°±è¿‘åˆå¹¶æˆä¸€ä¸ªç©ºç™½div"** çš„è§„åˆ™è¾“å‡ºä¸€ä¸ªæ–°çš„listã€‚

è¿™é‡Œä½¿ç”¨å¾ªç¯å»éå†æ€§èƒ½æ˜¯ä¼šæ¯”äºŒå‰æ ‘è¦å·®ï¼Œä½†æ˜¯å› ä¸ºåˆ—è¡¨é¡¹é«˜åº¦æ˜¯å¼‚æ­¥çš„ï¼Œæ‰€ä»¥åªèƒ½ä½¿ç”¨éå†çš„æ–¹å¼å»åˆ¤æ–­æ¯ä¸ªèŠ‚ç‚¹æ˜¯å¦å·²ç»ä¸ŠæŠ¥height(ä¸ŠæŠ¥heightæ„å‘³ç€å·²ç»åŠ è½½å®Œæˆäº†ï¼Œå°±å¯ä»¥æ¸²æŸ“äº†)

è¿™ä¸ªæ–¹æ³•æ˜¯é•¿åˆ—è¡¨ä¼˜åŒ–çš„æœ€æ ¸å¿ƒçš„æ–¹æ³•äº†ï¼Œå…¶ä»–æ–¹æ³•å¯ä»¥ç®€å•å®ç°ã€‚è¿™é‡Œæˆ‘ç®€å•åˆ—ä¸€ä¸‹ç»“æ„ä»¥åŠå®ƒçš„åŠŸèƒ½ï¼Œå…·ä½“çš„å®ç°å¯ä»¥çœ‹ä¸€ä¸‹[react-infinite-auto-scroll](https://github.com/sansui-orz/react-infinite-auto-scroller)ã€‚

å°†é•¿åˆ—è¡¨ä¼˜åŒ–ç»„ä»¶æ‹†åˆ†æˆä¸¤ä¸ªç»„ä»¶ï¼Œä¸€ä¸ªæ˜¯åˆ—è¡¨å®¹å™¨ï¼Œä¸€ä¸ªåŒ…è£¹åˆ—è¡¨é¡¹å®¹å™¨ã€‚

å…¶ä¸­`InfiniteScroll`ç»„ä»¶å¦‚ä¸‹ï¼š

```tsx
import InfiniteScrollItem from './scrollItem';

const map = new Map();

export function clearHeightCache() { // å› ä¸ºmapç¼“å­˜æ”¾åœ¨æ¨¡å—å†…ï¼Œæ‰€ä»¥æä¾›ä¸€ä¸ªä¸»åŠ¨æ¸…é™¤ç¼“å­˜çš„æ–¹æ³•ï¼Œå¦‚æœä¸æ¸…é™¤ï¼Œåˆ™ä¸‹æ¬¡æ¸²æŸ“è¯¥åˆ—è¡¨å°±å¯ä»¥ç›´æ¥ä½¿ç”¨ç¼“å­˜äº†ã€‚
  map.clear();
}

const inClient = typeof window !== 'undefined'; // åˆ¤æ–­æ˜¯å¦åœ¨å®¢æˆ·ç«¯ï¼Œç”¨æ¥æ”¯æŒæœåŠ¡ç«¯æ¸²æŸ“

export default class InfiniteScroller extends Component {
  state = {
    list: [],
    boxTop: 0,
  };

  lock = false; // å£°æ˜ä¸€ä¸ªå˜é‡ç”¨æ¥èŠ‚æµ

  windowHeight = inClient ? window.innerHeight : 700; // è§†å£é«˜åº¦

  // ...

  static getDerivedStateFromProps(props, state) { // æ³¨æ„éœ€è¦å°†ä¼ å…¥è¿›æ¥çš„åˆ—è¡¨è½¬åŒ–æˆç»„ä»¶å†…çš„stateï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦å¾€åˆ—è¡¨å†…æ·»åŠ å˜é‡
    const newList = props.list.map((item, index) => {
      const key = props.id ? item[props.id] : item;
      const mapItem = map.get(key) || {};
      return { ...item, is_height: mapItem.height, is_loaded: mapItem.loaded, is_index: index };
    });
    return { ...state, list: newList };
  }

  componentDidMount() {
    this.updateBoxTop(); // ä¸»åŠ¨è°ƒä¸€æ¬¡æ›´æ–°åˆ—è¡¨å®¹å™¨çš„top
    if (inClient) {
      this.getScrollElement().addEventListener('scroll', this.onScroll, false); // ç›‘å¬æµè§ˆå™¨æ»šåŠ¨ï¼Œæ›´æ–°åˆ—è¡¨å®¹å™¨çš„top
    }
  }

  // componentWillUnmount éœ€è¦å°†ç›‘å¬æ¸…é™¤

  // render å°±æ˜¯ä¸Šé¢æåˆ°çš„renderæ–¹æ³•

  // sortList åŒä¸Š

  reportHeight = (index, height, loaded) => { // æ³¨æ„è¿™é‡Œéœ€è¦åŒæ—¶æ›´æ–°mapå’Œstate
    const list: any[] = this.state.list;
    list[index].is_height = height;
    const key = this.getMapKey(list[index]);
    map.set(key, { height, loaded });
    this.setState({ list });
  }

  getMapKey = (item) => { // æ³¨æ„åˆ—è¡¨é¡¹éœ€è¦æŒ‡å®šä¸€ä¸ªkeyï¼Œç”¨indexåškeyçš„è¯é‡åˆ°åˆ—è¡¨å‰æ’å…¥æˆ–åˆ é™¤é¡¹ä¼šå¯¼è‡´mapç¼“å­˜èµ·æ¥çš„æ•°æ®é”™ä¹±
    return this.props.id && item ? item[this.props.id] : item;
  }

  // onScroll æ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œé€šè¿‡getBoundingClientRectè·å–åˆ—è¡¨å®¹å™¨çš„topå¹¶æ›´æ–°ï¼Œæœ€å¤šåŠ ä¸ªèŠ‚æµæ§åˆ¶ä¸€ä¸‹é¢‘ç‡

  // getScrollElement è€ƒè™‘åˆ°å¯èƒ½æ»šåŠ¨çš„ä¸æ˜¯windowï¼Œæ‰€ä»¥å…è®¸ä»å¤–éƒ¨ä¼ å…¥rootè·å–æ»šåŠ¨å…ƒç´ 

  // updateBoxTop æ›´æ–°stateçš„top
}
```

å¯ä»¥çœ‹åˆ°åˆ—è¡¨å®¹å™¨ç»„ä»¶ä¸»è¦ä½œç”¨å°±æ˜¯ç›‘å¬æ»šåŠ¨ï¼Œå¹¶å®æ—¶è®¡ç®—å“ªäº›åˆ—è¡¨é¡¹æ˜¯æ˜¾ç¤ºçš„ï¼Œä»¥åŠè®°å½•åˆ—è¡¨é¡¹çš„é«˜åº¦ã€‚

`InfiniteScrollItem`ç»„ä»¶å¦‚ä¸‹ã€‚

```tsx
export default class InfiniteScrollItem extends Component {
  ref = React.createRef();

  render() {
    const item = this.props.item;
    if (item.type === 'block') {
      return <div style={{ height: this.props.is_height }} ref={this.ref}></div>;
    }
    return (
      <div className="infinite-scroll-item" style={{ height: this.props.is_height || 'auto' }} ref={this.ref}>
        {this.props.renderItem({ ...this.props.item, emitReportHeight: this.changeHeight }, this.props.index)}
      </div>
    );
  }

  private changeHeight = (height, loaded) => {
      if (height && height !== this.props.is_height) {
        this.props.reportHeight(this.props.index, height, loaded);
      }
  }
}
```

InfiniteScrollItemç»„ä»¶å¾ˆç®€å•ï¼Œåªæ˜¯æä¾›ä¸€ä¸ªä¸ŠæŠ¥æ¥å£çš„æ–¹æ³•ï¼Œä»¥åŠåœ¨renderçš„æ—¶å€™åˆ¤æ–­æ˜¯æ¸²æŸ“ä¸€ä¸ªç©ºç™½èŠ‚ç‚¹è¿˜æ˜¯æ¸²æŸ“ç»„ä»¶ã€‚

å°†ç»„ä»¶æ¸²æŸ“å®Œæˆçš„å›è°ƒæä¾›ç»™ç»„ä»¶ä½¿ç”¨è€…ï¼Œå½“å®ƒç¡®å®šäº†é«˜åº¦ä¸å†å˜åŒ–åˆ™ä¸ŠæŠ¥é«˜åº¦ï¼Œç„¶åæ‰ä¼šæ ¹æ®å…¶åœ¨åˆ—è¡¨ä¸­æ‰€å¤„çš„ä½ç½®åˆ¤æ–­è¯¥å…ƒç´ æ˜¯å¦å¯è§ã€‚

### ä½¿ç”¨æ–¹å¼

è¿™ä¸ªé•¿åˆ—è¡¨ä¼˜åŒ–ç»„ä»¶æä¾›äº†ä¸€ä¸ªreactç»„ä»¶ä¸ä¸€ä¸ªapiã€‚

åœ¨åˆ—è¡¨çš„é¡µé¢æ’å…¥ç»„ä»¶`InfiniteScroll`:

```tsx
render() {
    return (
      <div className="list" ref={this.refList}>
        <InfiniteScroll
          id={'id'}
          list={this.state.list}
          renderItem={(item, index) => {
            return (
              <Item {...item} />
            );
          }}/>
      </div>
    );
  }
```

åœ¨åˆ—è¡¨é¡¹ç»„ä»¶ä¸­è°ƒç”¨`emitReportHeight`api:

```tsx
class Item extends Component<IProps> {
  ref = React.createRef();

  componentDidMount() {
    if (!this.props.img) { // é«˜åº¦ä¸ä¾èµ–å¼‚æ­¥èµ„æºä¹Ÿè¦ä¸»åŠ¨ç¡®è®¤é«˜åº¦
      this.reportHeight(true);
    }
  }

  render() {
    const { text, img, is_index } = this.props;
    return (
      <div className="item" ref={this.ref}>
        <p className="text">{text}</p>
        {img ? <img className="img" src={img} alt="" onLoad={this.imgLoad} onError={this.imgLoad}/> : null}
      </div>
    );
  }

  imgLoad = () => {
    this.reportHeight(true); // å›¾ç‰‡åŠ è½½æˆåŠŸæˆ–è€…å¤±è´¥éƒ½è¦ä¸»åŠ¨ç¡®è®¤é«˜åº¦
  };

  reportHeight(loaded) {
    const height = this.ref.current?.getBoundingClientRect().height;
    this.props.emitReportHeight && height && this.props.emitReportHeight(height, loaded);
  }
}


export default Item;
```

è¿™ä¸ªç»„ä»¶æœ€é‡è¦çš„ç‚¹åœ¨äºâ€œç»™åˆ—è¡¨é¡¹æä¾›å”¯ä¸€çš„keyâ€å’Œâ€œåœ¨åˆ—è¡¨é¡¹å†…ä¸»åŠ¨è°ƒç”¨apiç¡®å®šé«˜åº¦â€ã€‚

æœ€ç»ˆå‘ˆç°å‡ºæ¥çš„æ•ˆæœå¦‚ä¸‹ï¼š

![æ•ˆæœ](https://lms-flies.oss-cn-guangzhou.aliyuncs.com/blog/imgs/20200730145546.jpg!trans_webp)

## æ€»ç»“

æ€»çš„æ¥è¯´ï¼Œè¿™ä¸ªé•¿åˆ—è¡¨ä¼˜åŒ–æ–¹æ³•çš„åŸç†å°±æ˜¯â€œåªæ˜¾ç¤ºå¤„äºçª—å£ç‰¹å®šèŒƒå›´çš„å…ƒç´ ï¼Œå…¶ä»–å…ƒç´ é€šè¿‡åˆå¹¶æˆç©ºèŠ‚ç‚¹çš„å½¢å¼è¿›è¡Œéšè—ï¼Œå¹¶ä¸”é€šè¿‡ç›‘å¬çˆ¶èŠ‚ç‚¹çš„æ»šåŠ¨æ›´æ–°åˆ—è¡¨é¡¹çš„æ˜¾ç¤ºæˆ–éšè—â€ã€‚

æ³¨æ„ï¼š

1. è¿™ç§å®ç°æ–¹å¼å®ç°çš„åˆ—è¡¨é¡¹ä¼šè¢«é¢‘ç¹çš„æ’å…¥æˆ–è€…éšè—ï¼Œæ‰€ä»¥ä¸åº”è¯¥åœ¨æŒ‚è½½æˆ–å¸è½½çš„æ—¶å€™åšä¸€äº›ç‰¹æ®Šé€»è¾‘ã€‚

2. éœ€è¦å…³æ³¨å¼‚æ­¥åŠ è½½å¤±è´¥çš„æƒ…å†µï¼Œé‡æ–°åŠ è½½æˆ–è€…ç›´æ¥ä¸ŠæŠ¥é«˜åº¦ã€‚

å®Œæ•´ä»£ç è¯·çœ‹ ğŸ‘‰ [react-infinite-auto-scroller](https://github.com/sansui-orz/react-infinite-auto-scroller)
